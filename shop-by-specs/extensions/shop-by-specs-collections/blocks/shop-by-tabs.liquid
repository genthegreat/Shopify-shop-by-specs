{% comment %}
  Shop by Specs - Collection Tabs
  
  Displays related collections in an intuitive tabbed interface.
  Handles categories, manufacturers, heights, specs, and parts.
{% endcomment %}

{% assign page_current_collection = collection.handle %}
{% assign pos = collection.title | size | minus: 2 %}
{% assign page_collection_title = collection.title | slice: 0, pos | downcase %}
{% assign page_collection_type = collection.title | downcase | split: ' ' | join: '-' | replace: "'", "" | strip %}

{% assign base_product_fields = collection.products | map: 'metafields' | map: 'custom' %}

{% comment %} Check for multiple sizes {% endcomment %}
{%- assign sizes = base_product_fields | map: 'size_item' | uniq | sort -%}
{%- assign has_multiple_sizes = false -%}
{%- assign size_count = 0 -%}
{%- for size in sizes -%}
  {%- if size != blank -%}
    {%- assign size_count = size_count | plus: 1 -%}
    {%- if size_count > 1 -%}
      {%- assign has_multiple_sizes = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{% comment %} Check for multiple vendors {% endcomment %}
{%- assign collection_products = collections[page_current_collection].products -%}
{%- assign collection_vendors = collection_products | map: 'vendor' | uniq | sort -%}
{%- assign vendor_count = 0 -%}
{%- assign has_multiple_vendors = false -%}
{%- for vendor in collection_vendors -%}
  {%- assign vendor_count = vendor_count | plus: 1 -%}
  {%- if vendor_count > 1 -%}
    {%- assign has_multiple_vendors = true -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{% comment %} Check for multiple specs {% endcomment %}
{%- assign has_multiple_specs = false -%}

{%- assign conditions = base_product_fields | map: 'condition' | uniq | sort -%}
{%- assign condition_count = 0 -%}
{%- assign has_multiple_conditions = false -%}
{%- for condition in conditions -%}
  {%- if condition != blank -%}
    {%- assign condition_count = condition_count | plus: 1 -%}
    {%- if condition_count > 1 -%}
      {%- assign has_multiple_conditions = true -%}
      {%- assign has_multiple_specs = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign types = base_product_fields | map: 'type' | uniq | sort -%}
{%- assign type_count = 0 -%}
{%- assign has_multiple_types = false -%}
{%- for type in types -%}
  {%- if type != blank -%}
    {%- assign type_count = type_count | plus: 1 -%}
    {%- if type_count > 1 -%}
      {%- assign has_multiple_types = true -%}
      {%- assign has_multiple_specs = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign drivetrains = base_product_fields | map: 'drivetrain' | uniq | sort -%}
{%- assign drivetrain_count = 0 -%}
{%- assign has_multiple_drivetrains = false -%}
{%- for drivetrain in drivetrains -%}
  {%- if drivetrain != blank -%}
    {%- assign drivetrain_count = drivetrain_count | plus: 1 -%}
    {%- if drivetrain_count > 1 -%}
      {%- assign has_multiple_drivetrains = true -%}
      {%- assign has_multiple_specs = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign fuel_types = base_product_fields | map: 'fuel_type' | uniq | sort -%}
{%- assign fuel_type_count = 0 -%}
{%- assign has_multiple_fuel_types = false -%}
{%- for fuel_type in fuel_types -%}
  {%- if fuel_type != blank -%}
    {%- assign fuel_type_count = fuel_type_count | plus: 1 -%}
    {%- if fuel_type_count > 1 -%}
      {%- assign has_multiple_fuel_types = true -%}
      {%- assign has_multiple_specs = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

<div class="container" id="shop-by-specs-container" data-collection="{{ page_current_collection }}">
  <div class="title-buttons-grid">
    <button class="tablink active" onclick="openTab(event, 'category')">Search By Category</button>
    {% if has_multiple_vendors %}
      <button class="tablink" onclick="openTab(event, 'manufacturer')">Search By Manufacturer</button>
    {% endif %}
    {% if has_multiple_sizes %}
      <button class="tablink" onclick="openTab(event, 'height')">Search By Height</button>
    {% endif %}
    {% if has_multiple_specs %}
      <button class="tablink" onclick="openTab(event, 'specs')">Search By Specs</button>
    {% endif %}
    <button class="tablink" onclick="openTab(event, 'parts')">Search Parts</button>
  </div>

  <!-- Category Tab -->
  <div id="category" class="tab-content" style="display:block;">
    <div class="tab-inner-content">
      <div class="inner-grid" id="category-content">
        <div class="loading-indicator">Loading categories...</div>
        
        <!-- Default fallback content that will be replaced by JS or shown if JS fails -->
        <div class="fallback-content">
          {%- for collection in collections -%}
            {% assign current_collection_title = collection.title | downcase %}
            {% if collection.handle != page_current_collection
              and current_collection_title contains page_collection_title
              and collection.products.size > 0
            %}
              <div class="collection-card">
                <a href="{{ collection.url }}" class="collection-block-item">
                  <div class="collection-image">
                    <img
                      src="{{ collection.image | default: collection.products.first.featured_media | img_url: '300x300', crop: 'center' }}"
                      alt="{{ collection.title }}"
                      loading="lazy"
                    >
                  </div>
                  <h3>{{ collection.title }}</h3>
                </a>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>

  <!-- Manufacturer Tab -->
  <div id="manufacturer" class="tab-content" style="display:none;">
    <div class="tab-inner-content">
      <div class="inner-grid" id="manufacturer-content">
        <div class="loading-indicator">Loading manufacturers...</div>
        
        <!-- Fallback content for vendors -->
        <div class="fallback-content">
          {%- for vendor in collection_vendors -%}
            {%- assign collection_handle = vendor | downcase | replace: " ", "-" | replace: "/", "-" | append: "-" | append: page_collection_type %}

            <a href="/collections/{{ collection_handle }}" class="card-link">
              <div class="grid-card" data-brand="{{ vendor | downcase }}">
                {{ vendor }}
              </div>
            </a>
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>

  <!-- Height Tab -->
  <div id="height" class="tab-content" style="display:none;">
    <div class="tab-inner-content">
      <div class="inner-grid" id="height-content">
        <div class="loading-indicator">Loading heights...</div>
        
        <!-- Fallback content for sizes -->
        <div class="fallback-content">
          {%- for size in sizes -%}
            {%- if size != blank -%}
              {% assign formatted_size = size | downcase | replace: "' - ", "-" | replace: "' ", "-" | replace: "'", "" | replace: " ", "-" %}
              {% assign size_handle = formatted_size | append: "-" | append: page_collection_type %}
              <a
                href="/collections/{{ size_handle }}"
                class="card-link"
              >
                <div class="grid-card" data-size="{{ size | downcase }}">
                  {{ size }}
                </div>
              </a>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>

  <!-- Specs Tab -->
  <div id="specs" class="tab-content" style="display:none;">
    <div class="tab-inner-content">
      <div class="specs-content" id="specs-content">
        <div class="loading-indicator">Loading specs...</div>
        
        <!-- Fallback content for specs -->
        <div class="fallback-content">
          {% if has_multiple_conditions %}
            <h2>Search By Condition</h2>
            <div class="inner-grid">
              {%- for condition in conditions -%}
                {%- if condition != blank -%}
                  {% assign condition_handle = condition | downcase | replace: " ", "-" | replace: "/", "-" | append: "-" | append: page_collection_type %}
                  <a
                    href="/collections/{{ condition_handle }}"
                    class="card-link"
                  >
                    <div class="grid-card" data-condition="{{ condition | downcase }}">
                      {{ condition }}
                    </div>
                  </a>
                {%- endif -%}
              {%- endfor -%}
            </div>
          {% endif %}
          
          {% if has_multiple_fuel_types %}
            <h2>Search By Fuel Type</h2>
            <div class="inner-grid">
              {%- for fuel_type in fuel_types -%}
                {%- if fuel_type != blank -%}
                  {% assign fuel_type_handle = fuel_type | downcase | replace: " ", "-" | replace: "/", "-" | append: "-" | append: page_collection_type %}
                  <a
                    href="/collections/{{ fuel_type_handle }}"
                    class="card-link"
                  >
                    <div class="grid-card" data-fuel-type="{{ fuel_type | downcase }}">
                      {{ fuel_type }}
                    </div>
                  </a>
                {%- endif -%}
              {%- endfor -%}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Parts Tab -->
  <div id="parts" class="tab-content" style="display:none;">
    <div class="tab-inner-content">
      <div class="inner-grid" id="parts-content">
        <div class="loading-indicator">Loading parts...</div>
        
        <!-- Default parts content -->
        <div class="fallback-content">
          <a href="/collections/genie-parts" class="card-link">
            <div class="grid-card" data-part="genie parts">
              Genie Parts
            </div>
          </a>
          <a href="/collections/jlg-parts" class="card-link">
            <div class="grid-card" data-part="jlg parts">
              JLG Parts
            </div>
          </a>
          <a href="/collections/skyjack-parts" class="card-link">
            <div class="grid-card" data-part="skyjack parts">
              Skyjack Parts
            </div>
          </a>
          <a href="/collections/haulage-parts" class="card-link">
            <div class="grid-card" data-part="haulage parts">
              Haulage Parts
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .title-buttons-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tablink {
      background-color: #f1f1f1;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 10px 15px;
      font-size: 16px;
      flex-grow: 1;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    .tablink:hover {
      background-color: #ddd;
    }
    .tablink.active {
      background-color: #555;
      color: white;
    }
    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .inner-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }
    .grid-card {
      background-color: #f9f9f9;
      padding: 20px;
      text-align: center;
      border-radius: 5px;
      transition: all 0.3s;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .grid-card:hover {
      background-color: #eee;
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .card-link {
      text-decoration: none;
      color: inherit;
    }
    .specs-content h2 {
      margin-top: 30px;
      margin-bottom: 20px;
      font-size: 1.5em;
    }
    .collection-card {
      text-align: center;
    }
    .collection-image {
      width: 100%;
      height: 150px;
      overflow: hidden;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .collection-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    .collection-block-item {
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .collection-block-item:hover img {
      transform: scale(1.05);
    }
    .collection-block-item h3 {
      font-size: 1rem;
      margin: 10px 0;
    }
    .loading-indicator {
      text-align: center;
      padding: 20px;
      grid-column: 1 / -1;
      color: #777;
    }
  </style>

  {% comment %} Include external JS file {% endcomment %}
  {{ 'shop-by-tabs.js' | asset_url | script_tag }}
</div>

{% schema %}
{
  "name": "Shop by Tabs",
  "target": "section",
  "settings": []
}
{% endschema %}

